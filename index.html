<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Zahnputz-Party Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600;700&display=swap');

        /* --- Global Reset & Base --- */
        body {
            font-family: 'Fredoka', sans-serif;
            overflow: hidden;
            touch-action: manipulation;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- Transitions --- */
        .view-section {
            display: none;
            opacity: 0;
            transition: opacity 0.4s ease-in-out;
            height: 100vh;
            width: 100%;
            overflow-y: hidden; 
            position: absolute;
            top: 0; left: 0;
        }

        .view-section.active {
            display: flex;
            opacity: 1;
            z-index: 10;
        }

        /* Scrollable container for settings */
        .scroll-content {
            overflow-y: auto;
            height: 100%;
            width: 100%;
            -webkit-overflow-scrolling: touch;
        }

        /* --- Themes --- */
        .theme-morning { background: linear-gradient(180deg, #87CEEB 0%, #E0F7FA 60%, #FFD700 100%); }
        .theme-noon { background: linear-gradient(180deg, #29B6F6 0%, #81D4FA 100%); }
        .theme-evening { background: linear-gradient(180deg, #0B1026 0%, #2B32B2 100%); color: white; }

        /* --- Sun Animation --- */
        .sun {
            width: 140px; height: 140px;
            background: radial-gradient(circle, #FFD700 0%, #FFA500 100%);
            border-radius: 50%;
            box-shadow: 0 0 60px #FFD700;
            position: absolute;
            left: 50%; transform: translateX(-50%);
            z-index: 5;
            transition: bottom 1s ease-out, top 1s ease-out;
            pointer-events: none;
        }

        /* --- Stars --- */
        .stars { position: absolute; inset: 0; pointer-events: none; z-index: 0; }
        .star {
            position: absolute; background: white; border-radius: 50%;
            animation: twinkle 3s infinite ease-in-out;
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        /* --- Moon --- */
        .moon-container {
            width: 120px; height: 120px;
            position: relative; margin: 0 auto 20px auto;
            border-radius: 50%; overflow: hidden;
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.3);
            z-index: 10; pointer-events: none;
        }
        .moon-disk { width: 100%; height: 100%; background: #F4F6F0; position: absolute; }
        .moon-shadow {
            width: 100%; height: 100%; background: #0B1026;
            position: absolute; top: 0; left: 0; transition: transform 0.5s;
        }

        /* --- Music Note Animation --- */
        .music-note {
            position: absolute; font-size: 30px; color: rgba(255,255,255,0.9);
            animation: floatUp 3s linear infinite; pointer-events: none; z-index: 20;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        @keyframes floatUp {
            0% { transform: translateY(0) rotate(0deg); opacity: 0; }
            20% { opacity: 1; }
            100% { transform: translateY(-200px) rotate(20deg); opacity: 0; }
        }

        /* --- 3D Dice --- */
        .scene { width: 150px; height: 150px; perspective: 600px; cursor: pointer; }
        .cube {
            width: 100%; height: 100%; position: relative;
            transform-style: preserve-3d; transform: translateZ(-75px);
            transition: transform 1s ease-out;
        }
        .cube.rolling { animation: spin 0.5s infinite linear; }
        .cube__face {
            position: absolute; width: 150px; height: 150px;
            background: white; border: 4px solid #333; border-radius: 16px;
            display: flex; justify-content: center; align-items: center;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
        }
        .dot { width: 24px; height: 24px; background: #333; border-radius: 50%; position: absolute; }
        
        .cube__face--1  { transform: rotateY(  0deg) translateZ(75px); }
        .cube__face--2  { transform: rotateY( 90deg) translateZ(75px); }
        .cube__face--3  { transform: rotateY(180deg) translateZ(75px); }
        .cube__face--4  { transform: rotateY(-90deg) translateZ(75px); }
        .cube__face--5  { transform: rotateX( 90deg) translateZ(75px); }
        .cube__face--6  { transform: rotateX(-90deg) translateZ(75px); }

        .cube__face--1 .dot:nth-child(1) { top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .cube__face--2 .dot:nth-child(1) { top: 25%; left: 25%; }
        .cube__face--2 .dot:nth-child(2) { bottom: 25%; right: 25%; }
        .cube__face--3 .dot:nth-child(1) { top: 25%; left: 25%; }
        .cube__face--3 .dot:nth-child(2) { top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .cube__face--3 .dot:nth-child(3) { bottom: 25%; right: 25%; }
        .cube__face--4 .dot:nth-child(1) { top: 25%; left: 25%; }
        .cube__face--4 .dot:nth-child(2) { top: 25%; right: 25%; }
        .cube__face--4 .dot:nth-child(3) { bottom: 25%; left: 25%; }
        .cube__face--4 .dot:nth-child(4) { bottom: 25%; right: 25%; }
        .cube__face--5 .dot:nth-child(1) { top: 25%; left: 25%; }
        .cube__face--5 .dot:nth-child(2) { top: 25%; right: 25%; }
        .cube__face--5 .dot:nth-child(3) { top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .cube__face--5 .dot:nth-child(4) { bottom: 25%; left: 25%; }
        .cube__face--5 .dot:nth-child(5) { bottom: 25%; right: 25%; }
        .cube__face--6 .dot:nth-child(1) { top: 25%; left: 25%; }
        .cube__face--6 .dot:nth-child(2) { top: 25%; right: 25%; }
        .cube__face--6 .dot:nth-child(3) { bottom: 25%; left: 25%; }
        .cube__face--6 .dot:nth-child(4) { bottom: 25%; right: 25%; }
        .cube__face--6 .dot:nth-child(5) { top: 50%; left: 25%; transform: translateY(-50%); }
        .cube__face--6 .dot:nth-child(6) { top: 50%; right: 25%; transform: translateY(-50%); }

        @keyframes spin {
            0% { transform: rotateX(0deg) rotateY(0deg); }
            100% { transform: rotateX(360deg) rotateY(360deg); }
        }

        .btn-push { transition: transform 0.1s; }
        .btn-push:active { transform: scale(0.96); }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6);
            display: none; justify-content: center; align-items: center;
            z-index: 100; backdrop-filter: blur(5px);
        }
        .modal-content {
            background: white; border-radius: 24px; padding: 24px;
            max-width: 90%; width: 400px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-align: center;
        }
        @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .sparkle-text {
            background: linear-gradient(45deg, #FFD700, #FF69B4, #87CEEB);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            font-weight: 800;
        }
        
        /* Parent Gate Input */
        .numpad-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .num-btn { background: #f0f0f0; padding: 15px; border-radius: 10px; font-weight: bold; font-size: 1.2rem; }
        .num-btn:active { background: #ddd; }
    </style>
</head>
<body class="bg-gray-100 h-screen w-screen overflow-hidden">

    <!-- AUDIO -->
    <audio id="audio-player" loop></audio>
    <audio id="sfx-player" src="https://upload.wikimedia.org/wikipedia/commons/5/52/Service-Bell_Sound_Effect.ogg"></audio>

    <!-- GENERIC CONTENT MODAL -->
    <div id="content-modal" class="modal-overlay">
        <div class="modal-content relative">
            <button onclick="closeModal('content-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 p-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <div id="modal-icon" class="text-5xl mb-3 animate-bounce">‚ú®</div>
            <h3 id="modal-title" class="text-2xl font-bold mb-4 sparkle-text">Titel</h3>
            <div id="modal-body" class="text-lg text-gray-700 leading-relaxed min-h-[80px] flex items-center justify-center font-medium">
                Inhalt...
            </div>
            <button onclick="closeModal('content-modal')" class="mt-6 bg-blue-500 text-white px-8 py-3 rounded-2xl font-bold shadow-lg hover:bg-blue-600 w-full text-lg">Super!</button>
        </div>
    </div>

    <!-- PARENTAL GATE MODAL -->
    <div id="parent-modal" class="modal-overlay">
        <div class="modal-content bg-slate-50 border-2 border-slate-200">
            <div class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Elternbereich</div>
            <h3 class="text-xl font-bold text-slate-800 mb-2">Bist du erwachsen?</h3>
            <p class="text-slate-600 mb-4" id="math-problem">L√∂se: 3 + 4 = ?</p>
            <div class="bg-white border-2 border-slate-200 rounded-xl p-3 mb-4 h-12 flex items-center justify-center text-xl font-mono font-bold" id="math-input"></div>
            
            <div class="numpad-grid">
                <button class="num-btn" onclick="typeNum(1)">1</button>
                <button class="num-btn" onclick="typeNum(2)">2</button>
                <button class="num-btn" onclick="typeNum(3)">3</button>
                <button class="num-btn" onclick="typeNum(4)">4</button>
                <button class="num-btn" onclick="typeNum(5)">5</button>
                <button class="num-btn" onclick="typeNum(6)">6</button>
                <button class="num-btn" onclick="typeNum(7)">7</button>
                <button class="num-btn" onclick="typeNum(8)">8</button>
                <button class="num-btn" onclick="typeNum(9)">9</button>
                <button class="num-btn text-red-400" onclick="typeNum('C')">C</button>
                <button class="num-btn" onclick="typeNum(0)">0</button>
                <button class="num-btn bg-green-100 text-green-600" onclick="checkParentGate()">OK</button>
            </div>
            <button onclick="closeModal('parent-modal')" class="mt-4 text-gray-400 text-sm underline">Abbrechen</button>
        </div>
    </div>

    <!-- MAIN MENU -->
    <div id="menu-view" class="view-section active flex-col items-center justify-center bg-blue-50 relative">
        <div class="scroll-content flex flex-col items-center justify-center p-4">
            
            <!-- SETTINGS BUTTON (Parent Gate Protected) -->
            <button onclick="openParentGate()" class="absolute top-4 right-4 bg-white p-3 rounded-full shadow-sm text-gray-400 hover:text-gray-600 transition z-20">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </button>

            <h1 class="text-4xl font-extrabold text-blue-600 mb-2 text-center drop-shadow-sm tracking-tight">Zahnputz-Party</h1>
            <p class="text-gray-500 mb-6 text-lg font-medium">Wann putzen wir?</p>
            
            <div class="flex flex-col gap-4 w-full max-w-sm">
                
                <!-- Tooth Fairy (Offline Mode) -->
                <button onclick="showOfflineContent('joke')" class="btn-push w-full bg-white hover:bg-purple-50 text-purple-600 rounded-2xl p-4 shadow-sm border-2 border-purple-200 flex items-center justify-center gap-3 mb-2">
                    <span class="text-2xl">üßö‚Äç‚ôÄÔ∏è</span>
                    <span class="font-bold text-lg">Frag die Zahnfee</span>
                </button>

                <!-- MORNING -->
                <button onclick="startApp('morning')" class="btn-push w-full bg-gradient-to-r from-yellow-400 to-orange-400 text-white rounded-3xl p-5 shadow-lg flex items-center justify-between px-6 border-b-4 border-orange-600 relative overflow-hidden group">
                    <div class="flex items-center gap-4">
                        <div class="bg-white/20 p-2 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                        </div>
                        <span class="text-2xl font-bold">Morgens</span>
                    </div>
                </button>

                <!-- NOON -->
                <button onclick="startApp('noon')" class="btn-push w-full bg-gradient-to-r from-sky-400 to-blue-500 text-white rounded-3xl p-5 shadow-lg flex items-center justify-between px-6 border-b-4 border-blue-700 relative overflow-hidden">
                    <div class="flex items-center gap-4">
                        <div class="bg-white/20 p-2 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                        </div>
                        <span class="text-2xl font-bold">Mittags</span>
                    </div>
                </button>

                <!-- EVENING -->
                <button onclick="startApp('evening')" class="btn-push w-full bg-gradient-to-r from-indigo-600 to-purple-700 text-white rounded-3xl p-5 shadow-lg flex items-center justify-between px-6 border-b-4 border-indigo-900 relative overflow-hidden">
                    <div class="flex items-center gap-4">
                        <div class="bg-white/20 p-2 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                        </div>
                        <span class="text-2xl font-bold">Abends</span>
                    </div>
                </button>
            </div>

            <!-- Custom Music Selection -->
            <div class="mt-8 w-full max-w-sm">
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                    <label class="flex items-center gap-2 text-sm font-bold text-gray-500 mb-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path></svg>
                        Eigenes Lied (Optional)
                    </label>
                    <input type="file" id="music-upload" accept="audio/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                </div>
            </div>
        </div>
    </div>

    <!-- SETTINGS VIEW -->
    <div id="settings-view" class="view-section flex-col items-center bg-gray-50">
        <div class="scroll-content flex flex-col items-center p-6 w-full max-w-lg">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Einstellungen</h2>
            <p class="text-gray-500 mb-6 text-sm">Definiere die W√ºrfel-Belohnungen.</p>
            
            <button onclick="fillRandomRewards()" class="w-full bg-indigo-100 hover:bg-indigo-200 text-indigo-700 font-bold py-3 px-4 rounded-xl flex items-center justify-center gap-2 mb-6 transition">
                <span class="text-xl">üé≤</span> Vorschl√§ge w√ºrfeln
            </button>

            <div id="rewards-container" class="space-y-3 w-full mb-8"></div>

            <div class="flex gap-4 w-full">
                <button onclick="switchView('menu-view')" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-xl font-bold">Zur√ºck</button>
                <button onclick="saveSettings()" class="flex-1 bg-green-500 text-white py-3 rounded-xl font-bold shadow-md">Speichern</button>
            </div>
        </div>
    </div>


    <!-- TIMER VIEW -->
    <div id="timer-view" class="view-section flex-col items-center justify-between py-6 relative overflow-hidden">
        
        <button onclick="toggleMusic()" class="absolute top-4 right-4 z-30 bg-white/20 backdrop-blur-md p-3 rounded-full text-white hover:bg-white/40 transition">
            <svg id="music-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
            </svg>
        </button>

        <div id="visual-container" class="w-full flex-grow flex items-center justify-center relative pointer-events-none">
            <div id="sun-element" class="sun hidden"></div>
            <div id="stars-container" class="stars hidden"></div>
            <div id="moon-element" class="hidden flex flex-col items-center z-10">
                <div class="moon-container">
                    <div class="moon-disk"></div>
                    <div id="moon-shadow" class="moon-shadow"></div>
                </div>
            </div>
        </div>

        <div class="z-20 w-full flex flex-col items-center gap-6 px-6 pb-8">
            <div id="timer-display" class="text-8xl font-mono font-bold drop-shadow-md text-white tracking-tighter">03:00</div>
            
            <button id="start-btn" onclick="startTimer()" class="btn-push bg-green-500 hover:bg-green-600 text-white text-2xl font-bold py-5 px-10 rounded-full shadow-2xl border-b-4 border-green-700 w-full max-w-xs flex items-center justify-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                <span>Los geht's!</span>
            </button>

            <button id="penalty-btn" onclick="addPenalty()" class="btn-push bg-red-500/80 hover:bg-red-500 text-white font-bold py-2 px-6 rounded-xl hidden backdrop-blur-sm border border-white/20">
                +30s Nachputzen
            </button>
            
            <button onclick="resetApp()" class="text-white/70 hover:text-white font-medium text-sm py-2">Abbrechen</button>
        </div>
    </div>

    <!-- REWARD VIEW -->
    <div id="reward-view" class="view-section flex-col items-center justify-center bg-gradient-to-b from-purple-400 to-pink-500 text-white p-4">
        <h2 class="text-4xl font-black mb-2 text-center drop-shadow-sm">Sauber!</h2>
        <p class="text-xl mb-8 opacity-90 text-center font-medium">Hol dir deine Belohnung:</p>

        <div class="scene mb-8" onclick="rollDice()">
            <div class="cube" id="dice">
                <div class="cube__face cube__face--1"><div class="dot"></div></div>
                <div class="cube__face cube__face--2"><div class="dot"></div><div class="dot"></div></div>
                <div class="cube__face cube__face--3"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                <div class="cube__face cube__face--4"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                <div class="cube__face cube__face--5"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                <div class="cube__face cube__face--6"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
            </div>
            <div class="text-center mt-6 text-sm font-bold bg-white/20 py-1 px-3 rounded-full inline-block">W√ºrfel antippen</div>
        </div>

        <!-- Offline Story Button -->
        <button onclick="showOfflineContent('story')" class="btn-push w-full max-w-xs bg-indigo-600 hover:bg-indigo-700 text-white rounded-2xl p-4 shadow-lg border-b-4 border-indigo-800 flex items-center justify-center gap-3 mb-6">
            <span class="text-2xl">üìñ</span>
            <span class="font-bold text-lg">Gute-Nacht-Geschichte</span>
        </button>

        <div id="dice-result-container" class="min-h-[120px] w-full flex flex-col items-center justify-center text-center px-4">
            <div id="dice-number-display" class="hidden text-lg opacity-80 mb-2 font-bold">Du hast eine 3 gew√ºrfelt</div>
            <div id="dice-reward-display" class="text-3xl font-extrabold text-yellow-100 leading-tight drop-shadow-md"></div>
        </div>
        
        <button onclick="resetApp()" class="bg-white text-purple-600 px-10 py-3 rounded-full font-bold shadow-xl mt-4 hover:bg-gray-50 transition">Neustart</button>
    </div>

    <script>
        // --- OFFLINE CONTENT DATABASE (Replaces costly AI) ---
        const DB = {
            jokes: [
                "Was machen Z√§hne am liebsten? Bisschen feiern!",
                "Welcher Zahn kann bei√üen aber nicht kauen? Der L√∂wenzahn!",
                "Warum putzen wir Z√§hne? Damit die Karies-Monster ausziehen!",
                "Was sagt der eine Zahn zum anderen? Wackel nicht so!",
                "Zahnarzt: 'Ihre Z√§hne sind wie Sterne.' Patient: 'So strahlend?' Arzt: 'Nein, so weit auseinander!'",
                "Was ist das Lieblingsessen von Z√§hnen? Zahnpasta-Nudeln!"
            ],
            facts: [
                "Wusstest du? Deine Z√§hne sind so hart wie Steine!",
                "Haie haben unendlich viele Z√§hne. Wenn einer ausf√§llt, w√§chst ein neuer nach!",
                "Der Zahnschmelz ist das H√§rteste in deinem ganzen K√∂rper.",
                "Z√§hneputzen dauert 3 Minuten. So lang wie ein Popsong!",
                "Fr√ºher haben Menschen ihre Z√§hne mit Zweigen geputzt."
            ],
            stories: [
                "Der kleine Zahn Zini wollte gl√§nzen. Er rief: 'B√ºrste, komm her!' Schrubb, schrubb, schrubb - da war er blitzeblank und der hellste Stern im Mund.",
                "Prinzessin Perlzahn konnte nicht schlafen. Ihre Z√§hne f√ºhlten sich pelzig an. Nach dem Putzen waren sie glatt wie Glas und sie tr√§umte s√º√ü.",
                "Der B√§r Bruno hatte Honig gegessen. 'Ohje', dachte er. Schnell die B√ºrste her! Nach 3 Minuten war der Honig weg und Bruno lachte wei√ü.",
                "Die Zahnfee flog vorbei. Sie sah dein sauberes L√§cheln und streute ein bisschen Glitzerstaub auf dein Kissen. Gute Nacht!",
                "Im Land der Kauleisten war Party. Die Zahnb√ºrste war der DJ und die Zahnpasta tanzte Pogo. Alle wurden sauber und gl√ºcklich."
            ]
        };

        // --- Configuration ---
        const INITIAL_TIME = 180;
        let currentTime = INITIAL_TIME;
        let timerInterval = null;
        let isRunning = false;
        let currentMode = ''; 
        let isMusicPlaying = true;
        
        const DEFAULT_REWARDS = {
            1: "Kuscheln auf dem Sofa",
            2: "Eine kurze Geschichte",
            3: "Ein Lied singen",
            4: "Ein Kitzel-Angriff!",
            5: "5 Minuten l√§nger aufbleiben",
            6: "Wunsch-Belohnung!"
        };

        const REWARD_POOL = [
            "Eine Extra-Geschichte", "Ein Eis essen", "Ein Spiel spielen", 
            "10 Min l√§nger aufbleiben", "Lieblingsessen w√ºnschen", "Pfannkuchen-Fr√ºhst√ºck", 
            "Wohnzimmer-Picknick", "Zusammen backen", "H√∂rspiel h√∂ren", "Kissenschlacht", 
            "Filmabend", "Neues Buch leihen", "Zusammen malen", "Spielplatz-Besuch", 
            "H√∂hle bauen", "Verstecken spielen", "Puzzeln", "Klebetattoo", 
            "N√§gel lackieren", "Fahrradtour", "Enten f√ºttern", "Schaumbad", 
            "Disko tanzen", "Lustiges Foto", "Witze erz√§hlen", "Lego bauen", 
            "√úberraschungsei", "Sticker", "Seifenblasen", "Stra√üenkreide", 
            "Waldspaziergang", "Steine bemalen", "Knete spielen", "Obstsalat machen", 
            "Hei√üe Schokolade", "Basteln", "Tierpark", "Ball spielen", "Papierflieger", "Verkleiden"
        ];

        let currentRewards = {};
        
        // Use reliable Wikimedia sounds
        const SONGS = {
            morning: "https://upload.wikimedia.org/wikipedia/commons/6/69/Scott_Joplin_-_The_Entertainer_%281902%29.ogg",
            noon: "https://upload.wikimedia.org/wikipedia/commons/2/24/Mozart_-_Eine_kleine_Nachtmusik_-_1._Allegro.ogg",
            evening: "https://upload.wikimedia.org/wikipedia/commons/3/3d/Brahms-lullaby.ogg"
        };

        const audioPlayer = document.getElementById('audio-player');
        const sfxPlayer = document.getElementById('sfx-player');
        const uploadInput = document.getElementById('music-upload');
        let customSongUrl = null;

        // --- Init ---
        window.onload = function() {
            loadRewards();
            // Prevent accidental navigation
            history.pushState(null, null, location.href);
            window.onpopstate = function () { history.go(1); };
        };

        // --- Parental Gate Logic ---
        let parentGateAnswer = 0;
        let parentGateInput = "";

        function openParentGate() {
            const num1 = Math.floor(Math.random() * 5) + 2; // 2 to 6
            const num2 = Math.floor(Math.random() * 5) + 1; // 1 to 5
            parentGateAnswer = num1 + num2;
            document.getElementById('math-problem').innerText = `L√∂se: ${num1} + ${num2} = ?`;
            parentGateInput = "";
            updateGateDisplay();
            document.getElementById('parent-modal').style.display = 'flex';
        }

        function typeNum(n) {
            if (n === 'C') {
                parentGateInput = "";
            } else {
                if(parentGateInput.length < 2) parentGateInput += n;
            }
            updateGateDisplay();
        }

        function updateGateDisplay() {
            document.getElementById('math-input').innerText = parentGateInput;
        }

        function checkParentGate() {
            if (parseInt(parentGateInput) === parentGateAnswer) {
                closeModal('parent-modal');
                openSettings();
            } else {
                const display = document.getElementById('math-input');
                display.style.color = "red";
                display.style.borderColor = "red";
                setTimeout(() => {
                    display.style.color = "black";
                    display.style.borderColor = "#e2e8f0";
                    parentGateInput = "";
                    updateGateDisplay();
                }, 500);
            }
        }

        // --- Offline Content Logic ---
        function showOfflineContent(type) {
            let title = "";
            let content = "";
            let icon = "";

            if (type === 'joke') {
                // Randomly choose between joke or fact
                const isJoke = Math.random() > 0.4;
                const source = isJoke ? DB.jokes : DB.facts;
                content = source[Math.floor(Math.random() * source.length)];
                title = isJoke ? "Witz der Zahnfee" : "Schlaues Wissen";
                icon = "üßö‚Äç‚ôÄÔ∏è";
            } else if (type === 'story') {
                content = DB.stories[Math.floor(Math.random() * DB.stories.length)];
                title = "Gute Nacht Geschichte";
                icon = "üìñ";
            }

            document.getElementById('modal-icon').innerText = icon;
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-body').innerText = content;
            document.getElementById('content-modal').style.display = 'flex';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        // --- Settings Logic ---
        function loadRewards() {
            try {
                const saved = localStorage.getItem('zahnputz_rewards');
                currentRewards = saved ? JSON.parse(saved) : {...DEFAULT_REWARDS};
            } catch(e) {
                currentRewards = {...DEFAULT_REWARDS};
            }
        }

        function openSettings() {
            const container = document.getElementById('rewards-container');
            container.innerHTML = ''; 
            for (let i = 1; i <= 6; i++) {
                const row = document.createElement('div');
                row.className = "flex items-center gap-3 bg-white p-3 rounded-xl border border-gray-200 shadow-sm";
                row.innerHTML = `
                    <div class="flex-shrink-0 w-8 h-8 bg-slate-800 text-white font-bold rounded-lg flex items-center justify-center shadow">${i}</div>
                    <input type="text" id="reward-input-${i}" value="${currentRewards[i]}" 
                        class="flex-grow bg-transparent outline-none text-gray-700 placeholder-gray-400 font-medium" 
                        placeholder="Belohnung f√ºr ${i}...">
                `;
                container.appendChild(row);
            }
            switchView('settings-view');
        }

        function fillRandomRewards() {
            const shuffled = [...REWARD_POOL].sort(() => 0.5 - Math.random());
            const selected = shuffled.slice(0, 6);
            for (let i = 1; i <= 6; i++) {
                const input = document.getElementById(`reward-input-${i}`);
                if (input) {
                    input.value = selected[i-1];
                    input.parentElement.classList.add('ring-2', 'ring-indigo-300');
                    setTimeout(() => input.parentElement && input.parentElement.classList.remove('ring-2', 'ring-indigo-300'), 500);
                }
            }
        }

        function saveSettings() {
            const newRewards = {};
            for (let i = 1; i <= 6; i++) {
                const input = document.getElementById(`reward-input-${i}`);
                newRewards[i] = input.value.trim() || DEFAULT_REWARDS[i];
            }
            currentRewards = newRewards;
            localStorage.setItem('zahnputz_rewards', JSON.stringify(currentRewards));
            switchView('menu-view');
        }

        // --- App Logic ---
        uploadInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                customSongUrl = URL.createObjectURL(file);
            }
        });

        function switchView(viewId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
        }

        function resetApp() {
            stopTimer();
            stopMusic();
            currentTime = INITIAL_TIME;
            updateTimerDisplay();
            document.getElementById('start-btn').style.display = 'flex';
            document.getElementById('penalty-btn').classList.add('hidden');
            
            // Visual Resets
            const sun = document.getElementById('sun-element');
            sun.style.bottom = '-140px'; 
            sun.style.top = 'auto';
            
            const dice = document.getElementById('dice');
            dice.style.transform = 'translateZ(-75px) rotateX(0deg) rotateY(0deg)';
            dice.classList.remove('rolling');
            
            document.getElementById('dice-reward-display').innerText = '';
            document.getElementById('dice-number-display').classList.add('hidden');
            document.querySelectorAll('.music-note').forEach(el => el.remove());

            switchView('menu-view');
        }

        function startApp(mode) {
            currentMode = mode;
            const timerView = document.getElementById('timer-view');
            const sun = document.getElementById('sun-element');
            const moon = document.getElementById('moon-element');
            const stars = document.getElementById('stars-container');

            timerView.className = 'view-section active flex-col items-center justify-between py-6 relative overflow-hidden'; // reset classes
            sun.classList.add('hidden');
            moon.classList.add('hidden');
            stars.classList.add('hidden');
            stars.innerHTML = '';
            
            sun.style.transition = 'none';
            sun.style.bottom = '-140px';
            sun.style.top = 'auto';

            let song = SONGS.morning;

            if (mode === 'morning') {
                timerView.classList.add('theme-morning');
                sun.classList.remove('hidden');
                song = SONGS.morning;
            } 
            else if (mode === 'noon') {
                timerView.classList.add('theme-noon');
                sun.classList.remove('hidden');
                sun.style.bottom = 'auto';
                sun.style.top = '10%'; 
                song = SONGS.noon;
            }
            else {
                timerView.classList.add('theme-evening');
                moon.classList.remove('hidden');
                stars.classList.remove('hidden');
                generateStars();
                song = SONGS.evening;
            }
            
            audioPlayer.src = customSongUrl || song;
            audioPlayer.load(); 
            switchView('timer-view');
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(currentTime / 60);
            const seconds = currentTime % 60;
            document.getElementById('timer-display').innerText = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function startTimer() {
            if (isRunning) return;
            isRunning = true;
            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('penalty-btn').classList.remove('hidden');

            if(isMusicPlaying) audioPlayer.play().catch(() => {});

            // Animations
            const sun = document.getElementById('sun-element');
            if (currentMode === 'morning') {
                sun.style.transition = `bottom ${currentTime}s linear`;
                void sun.offsetWidth; 
                sun.style.bottom = '60%'; 
            } else if (currentMode === 'noon') {
                sun.style.transition = `top ${currentTime}s linear`;
                void sun.offsetWidth;
                sun.style.top = '30%'; 
            }

            spawnNotes();

            timerInterval = setInterval(() => {
                currentTime--;
                updateTimerDisplay();
                if (currentTime <= 0) finishTimer();
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            isRunning = false;
        }

        function toggleMusic() {
            isMusicPlaying = !isMusicPlaying;
            const icon = document.getElementById('music-icon');
            if (isMusicPlaying) {
                if(isRunning) audioPlayer.play();
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />';
            } else {
                audioPlayer.pause();
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" clip-rule="evenodd" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" />';
            }
        }

        function stopMusic() {
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
        }

        function spawnNotes() {
            if (!isRunning) return;
            if (Math.random() > 0.7) {
                const note = document.createElement('div');
                note.innerText = Math.random() > 0.5 ? '‚ô™' : '‚ô´';
                note.className = 'music-note';
                note.style.left = (Math.random() * 80 + 10) + '%';
                note.style.bottom = '10%';
                document.getElementById('visual-container').appendChild(note);
                setTimeout(() => note.remove(), 3000);
            }
            if (isRunning) requestAnimationFrame(spawnNotes);
        }

        function addPenalty() {
            if (!isRunning) return;
            currentTime += 30;
            updateTimerDisplay();
            const btn = document.getElementById('penalty-btn');
            btn.classList.add('bg-red-600');
            setTimeout(() => btn.classList.remove('bg-red-600'), 500);
            
            // Adjust animation durations logic omitted for brevity in this optimized version
        }

        function finishTimer() {
            stopTimer();
            stopMusic();
            sfxPlayer.currentTime = 0;
            sfxPlayer.play().catch(() => {});
            setTimeout(() => switchView('reward-view'), 1000);
        }

        function generateStars() {
            const container = document.getElementById('stars-container');
            container.innerHTML = '';
            for(let i=0; i<40; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                const size = Math.random() * 3 + 1;
                star.style.width = star.style.height = `${size}px`;
                star.style.top = `${Math.random() * 100}%`;
                star.style.left = `${Math.random() * 100}%`;
                star.style.animationDelay = `${Math.random() * 3}s`;
                container.appendChild(star);
            }
        }

        let canRoll = true;
        function rollDice() {
            if (!canRoll) return;
            canRoll = false;
            const dice = document.getElementById('dice');
            const rewardDisplay = document.getElementById('dice-reward-display');
            const numberDisplay = document.getElementById('dice-number-display');
            
            dice.classList.add('rolling');
            rewardDisplay.innerText = '';
            numberDisplay.classList.add('hidden');

            setTimeout(() => {
                dice.classList.remove('rolling');
                const result = Math.floor(Math.random() * 6) + 1;
                // Rotations calculated to show correct face
                const rotations = {
                    1: [0, 0], 2: [0, -90], 3: [0, 180], 
                    4: [0, 90], 5: [-90, 0], 6: [90, 0]
                };
                const [rx, ry] = rotations[result];
                dice.style.transform = `translateZ(-75px) rotateX(${rx + 720}deg) rotateY(${ry + 720}deg)`;
                
                setTimeout(() => {
                    numberDisplay.innerText = `Du hast eine ${result} gew√ºrfelt!`;
                    numberDisplay.classList.remove('hidden');
                    rewardDisplay.innerText = currentRewards[result];
                    canRoll = true;
                }, 1000);
            }, 800);
        }
    </script>
</body>
</html>


